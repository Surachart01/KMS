// ================================
// Prisma Schema : Key Management System
// รองรับการเบิก-คืนกุญแจ, ตรวจสอบเวลาคืน, ตัดคะแนน, แบนผู้ใช้
// ================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------- ENUMS ----------
enum Role {
  STUDENT
  TEACHER
  STAFF
  ADMIN
}

enum BookingStatus {
  BORROWED   // กำลังเบิกอยู่
  RETURNED   // คืนแล้ว
  LATE       // คืนเกินเวลา
  RESERVED   // จองไว้ (ระบบสร้างให้)
}

enum PenaltyType {
  LATE_RETURN
  MANUAL
}

enum AuthSource {
  SCHEDULE  // มาจากตารางเรียน (auto-generated)
  MANUAL    // เพิ่มด้วยมือโดย Staff
}

// ---------- SUBJECT - TEACHER ----------
model SubjectTeacher {
  id         String @id @default(uuid())

  subjectId  String
  teacherId  String

  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher User    @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([subjectId, teacherId])
}


// ---------- USERS ----------
model User {
  id            String   @id @default(uuid())

  /// รหัสนักศึกษา / รหัสบุคลากร (อ้างอิงกับเครื่อง ZKTEco)
  studentCode   String   @unique

  /// อีเมลสำหรับ Login (สำหรับ Staff/Admin)
  email         String?  @unique
  password      String?

  firstName     String
  lastName      String

  role          Role

  /// คะแนนเริ่มต้น 100 ใช้สำหรับระบบตัดคะแนน / แบน
  score         Int      @default(100)
  isBanned      Boolean  @default(false)



  /// กลุ่มเรียน (FK)
  sectionId     String?
  section       Section? @relation(fields: [sectionId], references: [id])

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  bookings        Booking[]
  logs            SystemLog[]
  subjectTeachers SubjectTeacher[]
  enrolledSchedules Schedule[] @relation("StudentSchedules")
  penaltyLogs     PenaltyLog[]
  authorizedRooms DailyAuthorization[]
}

// ---------- MAJORS ----------
model Major {
  id        String    @id @default(uuid())
  code      String    @unique
  name      String

  sections  Section[]

}

// ---------- SECTIONS ----------
model Section {
  id        String   @id @default(uuid())
  name      String
  
  majorId   String
  major     Major    @relation(fields: [majorId], references: [id])

  users     User[]
}

// ---------- SUBJECTS ----------
model Subject {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String

  /// อาจารย์ที่สอนวิชานี้
  teachers  SubjectTeacher[]

  /// ตารางสอนของวิชานี้
  schedules Schedule[]

  /// การจองที่เกี่ยวข้องกับวิชานี้
  bookings  Booking[]
  
  /// สิทธิ์ในการเบิกกุญแจรายวัน
  dailyAuthorizations DailyAuthorization[]
}

// ---------- SCHEDULES (เรียนตามตาราง) ----------
model Schedule {
  id          String   @id @default(uuid())

  subjectId   String
  subject     Subject  @relation(fields: [subjectId], references: [id])

  /// ห้องเรียน (FK → Key.roomCode)
  roomCode    String
  key         Key      @relation(fields: [roomCode], references: [roomCode])

  dayOfWeek   Int      // 1-7 (Mon-Sun)
  startTime   DateTime
  endTime     DateTime

  createdAt   DateTime @default(now())

  students    User[]   @relation("StudentSchedules")
  dailyAuthorizations DailyAuthorization[]
}

// ---------- KEYS ----------
model Key {
  id          String   @id @default(uuid())
  roomCode    String   @unique // เช่น LAB401
  slotNumber  Int      // ช่องในตู้

  isActive    Boolean  @default(true)

  bookings    Booking[]
  schedules   Schedule[]
}

// ---------- DAILY BOOKING (Raspberry Pi สร้างทุกวัน) ----------
model Booking {
  id            String   @id @default(uuid())

  userId        String
  user          User     @relation(fields: [userId], references: [id])

  keyId         String
  key           Key      @relation(fields: [keyId], references: [id])

  subjectId     String?  // ไม่มีเรียนก็เบิกได้
  subject       Subject? @relation(fields: [subjectId], references: [id])

  borrowAt      DateTime @default(now())
  dueAt         DateTime // เวลาที่ต้องคืน
  returnAt      DateTime?

  status        BookingStatus @default(BORROWED)
  reason        String?

  lateMinutes   Int      @default(0)
  penaltyScore  Int      @default(0)

  createdAt     DateTime @default(now())

  penaltyLogs   PenaltyLog[]
}

// ---------- PENALTY CONFIG (ตั้งค่าโดยเจ้าหน้าที่) ----------
model PenaltyConfig {
  id               String   @id @default(uuid())

  graceMinutes     Int      // เช่น 30 นาที
  scorePerInterval Int      // ตัดกี่คะแนน
  intervalMinutes  Int      // ทุกกี่นาทีที่ตัด
  restoreDays      Int      @default(7) // คืนคะแนนให้หลังจากกี่วัน

  isActive         Boolean  @default(true)

  createdAt        DateTime @default(now())
}

// ---------- PENALTY LOG ----------
model PenaltyLog {
  id          String   @id @default(uuid())

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  bookingId   String?
  booking     Booking? @relation(fields: [bookingId], references: [id])

  type        PenaltyType
  scoreCut    Int
  reason      String

  createdAt   DateTime @default(now())
}

// ---------- DAILY AUTHORIZATION (สิทธิ์เบิกกุญแจรายวัน) ----------
model DailyAuthorization {
  id          String   @id @default(uuid())
  
  /// ห้องที่มีสิทธิ์เบิก
  roomCode    String
  
  /// วันที่ (YYYY-MM-DD)
  date        DateTime @db.Date
  
  /// ช่วงเวลา
  startTime   DateTime
  endTime     DateTime
  
  /// ผู้ใช้ที่มีสิทธิ์
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  /// แหล่งที่มา
  source      AuthSource @default(MANUAL)
  
  /// อ้างอิงจาก Schedule (ถ้ามาจากการ sync)
  scheduleId  String?
  schedule    Schedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  
  /// วิชา (optional)
  subjectId   String?
  subject     Subject?  @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime @default(now())
  createdBy   String?  // Staff/Admin ที่เพิ่ม
  
  @@unique([userId, roomCode, date, startTime])
  @@index([roomCode, date])
  @@index([userId, date])
}

// ---------- SYSTEM LOG ----------
model SystemLog {
  id          String   @id @default(uuid())

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  action      String
  details     String?
  ipAddress   String?

  createdAt   DateTime @default(now())
}
