import XLSX from 'xlsx';
import fs from 'fs';
import path from 'path';

/**
 * สร้าง Excel Template สำหรับ Import นักศึกษา
 */
export function generateStudentTemplate() {
    // สร้าง workbook ใหม่
    const wb = XLSX.utils.book_new();

    // ========================================================================
    // Sheet 1: Template สำหรับกรอกข้อมูล
    // ========================================================================
    // ========================================================================
    // Sheet 1: Template สำหรับกรอกข้อมูล
    // ========================================================================
    const templateData = [
        // Header row พร้อมคำอธิบาย
        ['รหัสนักศึกษา*', 'ชื่อ*', 'นามสกุล*', 'สาขาวิชา*', 'กลุ่มเรียน'],
        // Example row
        ['67-020415-1001-6', 'สมชาย', 'ใจดี', 'วิศวกรรมคอมพิวเตอร์', '1/1'],
        ['67-020415-1002-4', 'สมหญิง', 'รักเรียน', 'วิศวกรรมคอมพิวเตอร์', '1/1'],
        // Empty rows for data entry
        ['', '', '', '', ''],
    ];

    const ws1 = XLSX.utils.aoa_to_sheet(templateData);

    // กำหนดความกว้างของคอลัมน์
    ws1['!cols'] = [
        { wch: 20 }, // รหัสนักศึกษา
        { wch: 15 }, // ชื่อ
        { wch: 15 }, // นามสกุล
        { wch: 25 }, // สาขาวิชา
        { wch: 12 }, // กลุ่มเรียน
    ];

    // เพิ่ม sheet แรก
    XLSX.utils.book_append_sheet(wb, ws1, 'นักศึกษา');

    // ========================================================================
    // Sheet 2: คำแนะนำการใช้งาน
    // ========================================================================
    const instructionsData = [
        ['คำแนะนำการใช้งาน Excel Template สำหรับ Import นักศึกษา'],
        [''],
        ['1. คอลัมน์ที่มีเครื่องหมาย * เป็นคอลัมน์บังคับ ต้องกรอกข้อมูล'],
        [''],
        ['2. รหัสนักศึกษา:'],
        ['   - ต้องไม่ซ้ำกับที่มีในระบบ'],
        ['   - รูปแบบ: XX-XXXXXX-XXXX-X (เช่น 67-020415-1001-6)'],
        [''],
        ['3. สาขาวิชา:'],
        ['   - ต้องมีอยู่ในระบบแล้ว'],
        ['   - ดูรายชื่อสาขาได้ใน Sheet "สาขาวิชา"'],
        [''],
        ['4. กลุ่มเรียน (Optional):'],
        ['   - ถ้าไม่ระบุจะไม่มีกลุ่มเรียน'],
        ['   - ถ้าระบุต้องเป็นกลุ่มที่มีอยู่ในสาขาวิชานั้น'],
        [''],
        ['5. รหัสผ่าน และ อีเมล:'],
        ['   - ระบบจะสร้างให้อัตโนมัติจากรหัสนักศึกษา'],
        ['   - รหัสผ่านเริ่มต้นคือ รหัสนักศึกษา'],
        ['   - อีเมลคือ s<รหัสนักศึกษาเฉพาะตัวเลข>@email.kmutnb.ac.th'],
        [''],
        ['6. วิธีการ Import:'],
        ['   - บันทึกไฟล์ Excel นี้'],
        ['   - เข้าสู่ระบบเป็น Admin หรือ Staff'],
        ['   - ไปที่เมนู "จัดการนักศึกษา" > "Import จาก Excel"'],
        ['   - เลือกไฟล์และกดยืนยัน'],
        [''],
        ['7. หมายเหตุ:'],
        ['   - อย่าลบหรือแก้ไข header row (แถวแรก)'],
        ['   - ข้อมูลตัวอย่างในแถวที่ 2-3 สามารถลบได้'],
        ['   - สามารถเพิ่มข้อมูลได้ไม่จำกัดจำนวนแถว'],
    ];

    const ws2 = XLSX.utils.aoa_to_sheet(instructionsData);
    ws2['!cols'] = [{ wch: 80 }];
    XLSX.utils.book_append_sheet(wb, ws2, 'คำแนะนำ');

    // ========================================================================
    // Sheet 3: ตัวอย่างสาขาวิชา (จะต้องดึงจาก DB จริง)
    // ========================================================================
    const majorsData = [
        ['รายชื่อสาขาวิชาที่มีในระบบ'],
        [''],
        ['หมายเหตุ: ข้อมูลนี้เป็นตัวอย่าง กรุณาตรวจสอบสาขาจริงในระบบ'],
        [''],
        ['สาขาวิชา'],
        ['วิศวกรรมคอมพิวเตอร์'],
        ['วิศวกรรมอิเล็กทรอนิกส์'],
        ['วิศวกรรมเครื่องกล'],
        ['วิศวกรรมไฟฟ้า'],
    ];

    const ws3 = XLSX.utils.aoa_to_sheet(majorsData);
    ws3['!cols'] = [{ wch: 35 }];
    XLSX.utils.book_append_sheet(wb, ws3, 'สาขาวิชา');

    return wb;
}

/**
 * บันทึก Excel template ลงไฟล์
 */
export function saveStudentTemplate(outputPath) {
    const wb = generateStudentTemplate();
    XLSX.writeFile(wb, outputPath);
    return outputPath;
}

/**
 * ส่ง Excel template เป็น buffer (สำหรับ download ผ่าน API)
 */
export function getStudentTemplateBuffer() {
    const wb = generateStudentTemplate();
    return XLSX.write(wb, { type: 'buffer', bookType: 'xlsx' });
}
